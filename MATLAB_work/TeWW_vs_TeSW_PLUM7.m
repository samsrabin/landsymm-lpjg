%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% TeWW or TeSW? (PLUM7) %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% inDir = '/Volumes/WDMPP_Storage/Shared/PLUM/trunk_runs/justEvenWheats_1850-2005/output-2018-01-13-153758' ;
% %  inFile_cropfracs = '/Users/Shared/remapping_MIRCA/crop_fractions_fromMIRCA_PLUM7_1yr_20180105a.out' ;
% % outFile_cropfracs = '/Users/Shared/remapping_MIRCA/crop_fractions_fromMIRCA_PLUM7_XXXX-XXXX_20180105a.assignWWorSW.out' ;
% % outPrec_LC = 6 ;
% %  inFile_nfert = '/Users/Shared/PLUM/input/Nfert/LUH2/Nfert_fromLUH2.min5kgha.1850-2010.64493.20170116.txt' ;
% % outFile_nfert = '/Users/Shared/PLUM/input/Nfert/LUH2/Nfert_fromLUH2.min5kgha.XXXX-XXXX.64493.20170116.assignWWorSW.txt' ;
% % outPrec_mgmtInputs = 6 ;
% % % % % CFTnames_in  = {'CerealsC3','CerealsC4','Rice','Oilcrops','Pulses','StarchyRoots','Miscanthus',...
% % % % %                 'CerealsC3i','CerealsC4i','Ricei','Oilcropsi','Pulsesi','StarchyRootsi','Miscanthusi'} ;
% % % % % CFTnames_out = {'CerealsC3s','CerealsC3w','CerealsC4','Rice','Oilcrops','Pulses','StarchyRoots','Miscanthus',...
% % % % %                 'CerealsC3si','CerealsC3wi','CerealsC4i','Ricei','Oilcropsi','Pulsesi','StarchyRootsi','Miscanthusi'} ;
%  inFile_cropfracs = '/Users/Shared/remapping_MIRCA/crop_fractions_fromMIRCA_PLUM7_1yr_20180105b.out' ;
% outFile_cropfracs = '/Users/Shared/remapping_MIRCA/crop_fractions_fromMIRCA_PLUM7_XXXX-XXXX_20180105b.assignWWorSW.out' ;
% outPrec_LC = 6 ;
%  inFile_nfert = '' ;
% outFile_nfert = '' ;
% outPrec_mgmtInputs = 6 ;

% inDir = '/Volumes/WDMPP_Storage/Shared/PLUM/trunk_runs/justEvenWheats_1901-2005_cruncep/output-2018-02-01-031840' ;
% inFile_cropfracs = '/Users/Shared/remapping_MIRCA/crop_fractions_fromMIRCA_PLUM7_1yr_20180105b.out' ;
% outFile_cropfracs = '/Users/Shared/remapping_MIRCA/crop_fractions_fromMIRCA_PLUM7_XXXX-XXXX_20180105b.assignWWorSW_cruncep.out' ;
% outPrec_LC = 6 ;
% inFile_nfert = '/Users/Shared/PLUM/input/Nfert/LUH2/Nfert_fromLUH2.min5kgha.1850-2010.64493.20170116.txt' ;
% outFile_nfert = '/Users/Shared/PLUM/input/Nfert/LUH2/Nfert_fromLUH2.min5kgha.XXXX-XXXX.YYYYY.20170116.WWandSW.txt' ;
% outPrec_mgmtInputs = 6 ;

% inDir = '/Volumes/WDMPP_Storage/Shared/PLUM/trunk_runs/justEvenWheats_1850-2005_cmip5/output-2018-02-01-031834' ;
%  inFile_cropfracs = '/Users/Shared/remapping_MIRCA/crop_fractions_fromMIRCA_PLUM7_1yr_20180105b.out' ;
% outFile_cropfracs = '/Users/Shared/remapping_MIRCA/crop_fractions_fromMIRCA_PLUM7_XXXX-XXXX_20180105b.assignWWorSW_cmip5.out' ;
% outPrec_LC = 6 ;
%  inFile_nfert = '' ;
% outFile_nfert = '' ;
% outPrec_mgmtInputs = 6 ;

% inDir = '/Volumes/WDMPP_Storage/Shared/PLUM/trunk_runs/justEvenWheats_1901-2005_cruncep/output-2018-02-01-031840' ;
% inFile_cropfracs = '/Users/Shared/PLUM/input/remaps_v2/cropfracs.remapv2.20180210.m0.txt' ;
% outFile_cropfracs = '/Users/Shared/PLUM/input/remaps_v2/cropfracs.remapv2.20180210.m0.assignWWorSW_cruncep.txt' ;
% outPrec_LC = 6 ;
% inFile_nfert = '/Users/Shared/PLUM/input/remaps_v2/nfert.remapv2.20180210.m0.txt' ;
% outFile_nfert = '/Users/Shared/PLUM/input/remaps_v2/nfert.remapv2.20180210.m0.WWandSW.txt' ;
% outPrec_mgmtInputs = 6 ;

% inDir = '/Volumes/WDMPP_Storage/Shared/PLUM/trunk_runs/justEvenWheats_1901-2005_cruncep/output-2018-02-01-031840' ;
% inFile_cropfracs = '/Users/Shared/PLUM/input/remaps_v2/cropfracs.remapv2.20180214.m0.txt' ;
% outFile_cropfracs = '/Users/Shared/PLUM/input/remaps_v2/cropfracs.remapv2.20180214.m0.assignWWorSW_cruncep.txt' ;
% outPrec_LC = 6 ;
% inFile_nfert = '/Users/Shared/PLUM/input/remaps_v2/nfert.remapv2.20180214.m0.txt' ;
% outFile_nfert = '/Users/Shared/PLUM/input/remaps_v2/nfert.remapv2.20180214.m0.WWandSW.txt' ;
% outPrec_mgmtInputs = 6 ;

inDir = '/Volumes/WDMPP_Storage/Shared/PLUM/trunk_runs/justEvenWheats_1850-2005_cmip5/output-2018-02-01-031834' ;
inFile_cropfracs = '/Users/Shared/PLUM/input/remaps_v2/cropfracs.remapv2.20180214.m0.txt' ;
outFile_cropfracs = '/Users/Shared/PLUM/input/remaps_v2/cropfracs.remapv2.20180214.m0.assignWWorSW_cmip5_XXXX-XXXX.txt' ;
outPrec_LC = 6 ;
inFile_nfert = '' ;
outFile_nfert = '' ;
outPrec_mgmtInputs = 6 ;



%% Setup

addpath(genpath(landsymm_lpjg_path()))

inDir = find_PLUM2LPJG_run(inDir) ;

% Anonymous function for checking whether any version of a file exists
anyfileexist = @(in_file) ...
    exist(in_file,'file') ...
    || exist([in_file '.maps.mat'],'file') ...
    || exist([in_file '.mat'],'file') ...
    || exist([in_file '.gz'],'file') ;

% Get CFTs of interest
CFTnames = {'TeWW','TeSW','TeWWi','TeSWi'} ;
Ncfts = length(CFTnames) ;

% For output
force_overwrite = true ;
fclose_every = 1000 ;
pct_progress = 5 ;
lons_all = -179.75:0.5:179.75 ;
lats_all = -89.75:0.5:89.75 ;
lons_map = repmat(lons_all,[length(lats_all) 1]) ;
lats_map = repmat(lats_all',[1 length(lons_all)]) ;



%% Import

disp('Importing...')
yield = lpjgu_matlab_readTable_then2map([inDir 'yield.out'],'force_mat_save',true,'verboseIfNoMat',true) ;
hdate1 = lpjgu_matlab_readTable_then2map([inDir 'hdate1.out'],'force_mat_save',true,'verboseIfNoMat',true) ;
hdate2 = lpjgu_matlab_readTable_then2map([inDir 'hdate2.out'],'force_mat_save',true,'verboseIfNoMat',true) ;

% Trim unnecessary CFTs
disp('Finishing...')
[~,IA] = setdiff(yield.varNames,CFTnames) ;
if length(yield.varNames)-length(IA) ~= Ncfts
    error('length(yield.varNames)-length(IA) ~= Ncfts')
elseif length(hdate1.varNames)-length(IA) ~= Ncfts
    error('length(hdate1.varNames)-length(IA) ~= Ncfts')
elseif length(hdate2.varNames)-length(IA) ~= Ncfts
    error('length(hdate2.varNames)-length(IA) ~= Ncfts')
end
yield.maps_YXvy(:,:,IA,:) = [] ;
yield.varNames(IA) = [] ;
hdate1.maps_YXvy(:,:,IA,:) = [] ;
hdate1.varNames(IA) = [] ;
hdate2.maps_YXvy(:,:,IA,:) = [] ;
hdate2.varNames(IA) = [] ;

% Get info
yearList_in = yield.yearList ;
Nyears = length(yearList_in) ;
isOK_YX = ~isnan(yield.maps_YXvy(:,:,1,1)) ;
if ~isequal(size(lons_map),size(isOK_YX))
    error('~isequal(size(lons_map),size(isOK_YX))')
end

disp('Done.')


%% Find where TeWW(i) is better (complicated)

disp('Finding where TeWW(i) is better...')

y1s_in = ceil((min(yearList_in)+1)/5)*5+1:5:floor(max(yearList_in)/5)*5-4 ;
yNs_in = y1s_in+4 ;

y1s_out = y1s_in + 5 ;
yNs_out = yNs_in + 5 ;

Npds = length(y1s_in) ;

TeWW_better_YXp = false(size(yield.maps_YXvy,1),size(yield.maps_YXvy,2),Npds) ;
TeWWi_better_YXp = false(size(yield.maps_YXvy,1),size(yield.maps_YXvy,2),Npds) ;
for p = 1:Npds
    % Get indices
    thisY1 = y1s_in(p) ;
    thisYN = yNs_in(p) ;
    I = yield.yearList>=thisY1 & yield.yearList<=thisYN ;
    % Disp info
    thisY1_out = y1s_out(p) ;
    thisYN_out = yNs_out(p) ;
    disp(['   ' num2str(thisY1) '-' num2str(thisYN) ' --> ' num2str(thisY1_out) '-' num2str(thisYN_out)])
    % Get data
    tmpYield_YXv = sum(yield.maps_YXvy(:,:,:,I),4) ;
    tmpHdate1_YXvy = hdate1.maps_YXvy(:,:,:,I) ;
    tmpHdate2_YXvy = hdate2.maps_YXvy(:,:,:,I) ;
    Nharvs_YXv = sum(tmpHdate1_YXvy>0,4) + sum(tmpHdate2_YXvy>0,4) ;
    % Calculate mean per-season yield
    tmpYield_TeWW = tmpYield_YXv(:,:,strcmp(yield.varNames,'TeWW')) ./ Nharvs_YXv(:,:,strcmp(yield.varNames,'TeWW')) ;
    tmpYield_TeSW = tmpYield_YXv(:,:,strcmp(yield.varNames,'TeSW')) ./ Nharvs_YXv(:,:,strcmp(yield.varNames,'TeSW')) ;
    tmpYield_TeWWi = tmpYield_YXv(:,:,strcmp(yield.varNames,'TeWWi')) ./ Nharvs_YXv(:,:,strcmp(yield.varNames,'TeWWi')) ;
    tmpYield_TeSWi = tmpYield_YXv(:,:,strcmp(yield.varNames,'TeSWi')) ./ Nharvs_YXv(:,:,strcmp(yield.varNames,'TeSWi')) ;
    % Get which is better
    TeWW_better_YXp(:,:,p) = tmpYield_TeWW >= tmpYield_TeSW ;
    TeWWi_better_YXp(:,:,p) = tmpYield_TeWWi >= tmpYield_TeSWi ;
end

disp('   Finishing...')

% Expand
TeWW_better_YXy = repmat(TeWW_better_YXp,[1 1 1 5]) ;
TeWW_better_YXy = permute(TeWW_better_YXy,[1 2 4 3]) ;
TeWW_better_YXy = reshape(TeWW_better_YXy,[size(TeWW_better_YXp,1) size(TeWW_better_YXp,2) Npds*5]) ;
TeWWi_better_YXy = repmat(TeWWi_better_YXp,[1 1 1 5]) ;
TeWWi_better_YXy = permute(TeWWi_better_YXy,[1 2 4 3]) ;
TeWWi_better_YXy = reshape(TeWWi_better_YXy,[size(TeWWi_better_YXp,1) size(TeWWi_better_YXp,2) Npds*5]) ;
yearList_tmp = y1s_out(1):yNs_out(end) ;

% Prepend first "out" year to line up beginnings of in and out
Nmissing = length(find(yearList_in<y1s_out(1))) ;
TeWW_better_YXy = cat(3,repmat(TeWW_better_YXy(:,:,1),[1 1 Nmissing]),TeWW_better_YXy) ;
TeWWi_better_YXy = cat(3,repmat(TeWWi_better_YXy(:,:,1),[1 1 Nmissing]),TeWWi_better_YXy) ;
yearList_out = [yearList_in ; yearList_tmp(end-4:end)'] ;
Nyears_out = length(yearList_out) ;
if Nyears_out ~= size(TeWW_better_YXy,3) || Nyears_out ~= size(TeWWi_better_YXy,3)
    error('Nyears_out ~= size(TeWW_better_YXy,3) || Nyears_out ~= size(TeWWi_better_YXy,3)')
end
disp('Done.')


%% Import cropfracs

cropfracs_in = lpjgu_matlab_readTable_then2map(inFile_cropfracs,'force_mat_save',true,'verboseIfNoMat',true) ;
if length(find(~isnan(mean(cropfracs_in.maps_YXv,3)))) ...
        ~= length(cropfracs_in.list_to_map)
    warning('cropfracs_in.list_to_map is wrong! Re-making.')
    cropfracs_in.list_to_map = find(~isnan(mean(cropfracs_in.maps_YXv,3))) ;
end
%%
% CFTnames = {'TeWWi','TeSWi','TeCoi','TrRii','TeWW','TeSW','TeCo','TrRi'} ;
% if ~isequal(CFTnames,cropfracs_in.varNames)
%     error('Rework code to work with this exact set of cropfracs_in.varNames!')
% end
CFTnames = cropfracs_in.varNames ;
Ncfts = length(CFTnames) ;

% Get cropfracs_in.maps_YXvy, if needed
if ~isfield(cropfracs_in,'maps_YXvy')
    cropfracs_in.maps_YXvy = repmat(cropfracs_in.maps_YXv,[1 1 1 Nyears_out]) ;
    cropfracs_in.yearList = yearList_out ;
end

% Restrict to where there is yield data
if ~isequal(sort(cropfracs_in.list_to_map),sort(yield.list_to_map))
    error('Restrict cropfracs_in to where there is yield data!')
end

% Make sure yearLists match!
if ~isequal(cropfracs_in.yearList,yearList_out)
    error('~isequal(cropfracs_in.yearList,yearList_out)')
end

% Set up for output
cropfracs_out = cropfracs_in ;
if isfield(cropfracs_out,'maps_YXv')
    cropfracs_out = rmfield(cropfracs_out,'maps_YXv') ;
end


%% Import Nfert

if ~isempty(inFile_nfert)
    nfert_in = lpjgu_matlab_readTable_then2map(inFile_nfert,'force_mat_save',true,'verboseIfNoMat',true) ;
    
    
    % Set nfert_1yr; check years, if needed
    if ~isfield(nfert_in,'maps_YXvy')
        nfert_1yr = true ;
        if length(find(~isnan(mean(nfert_in.maps_YXv,3)))) ...
                ~= length(nfert_in.list_to_map)
            warning('nfert_in.list_to_map is wrong! Re-making.')
            nfert_in.list_to_map = find(~isnan(mean(nfert_in.maps_YXv,3))) ;
        end
    else
        nfert_1yr = false ;
        nfert_out.maps_YXvy(:,:,:,nfert_in.yearList<yearList_out(1) | nfert_in.yearList>yearList_out(end)) = [] ;
        nfert_out.yearList(nfert_in.yearList<yearList_out(1) | nfert_in.yearList>yearList_out(end)) = [] ;
        if ~isequal(nfert_out.yearList,yearList_out)
            error('~isequal(nfert_out.yearList,yearList_out)')
        end
        if length(find(~isnan(mean(mean(nfert_in.maps_YXvy,4),3)))) ...
                ~= length(nfert_in.list_to_map)
            warning('nfert_in.list_to_map is wrong! Re-making.')
            nfert_in.list_to_map = find(~isnan(mean(mean(nfert_in.maps_YXvy,4),3))) ;
        end
    end
    
    % Restrict to where there is yield data
    if ~isequal(sort(nfert_in.list_to_map),sort(yield.list_to_map))
        error('Restrict nfert_in to where there is yield data!')
    end
    
    % Set up for output
    nfert_out = nfert_in ;
    
end



%% Assign original CerealsC3(i) to either CerealsC3s(i) or CerealsC3w(i)

% Do it: cropfracs, rainfed
tmpVarNames = cropfracs_out.varNames ;
tmpVarNames{strcmp(cropfracs_out.varNames,'CerealsC3')} = 'CerealsC3w' ;
tmpVarNames{end+1} = 'CerealsC3s' ;
cropfracs_out.varNames = tmpVarNames ;
tmpWW_YXy = squeeze(cropfracs_out.maps_YXvy(:,:,strcmp(cropfracs_out.varNames,'CerealsC3w'),:)) ;
tmpSW_YXy = nan(size(tmpWW_YXy)) ;
tmpSW_YXy(~TeWW_better_YXy) = tmpWW_YXy(~TeWW_better_YXy) ;
tmpSW_YXy(TeWW_better_YXy) = 0 ;
tmpWW_YXy(~TeWW_better_YXy) = 0 ;
cropfracs_out.maps_YXvy(:,:,strcmp(cropfracs_out.varNames,'CerealsC3w'),:) = reshape(tmpWW_YXy,[size(tmpWW_YXy,1) size(tmpWW_YXy,2) 1 size(tmpWW_YXy,3)]) ;
cropfracs_out.maps_YXvy(:,:,strcmp(cropfracs_out.varNames,'CerealsC3s'),:) = reshape(tmpSW_YXy,[size(tmpSW_YXy,1) size(tmpSW_YXy,2) 1 size(tmpSW_YXy,3)]) ;
clear tmp*

% Do it: cropfracs, irrigated
tmpVarNames = cropfracs_out.varNames ;
tmpVarNames{strcmp(cropfracs_out.varNames,'CerealsC3i')} = 'CerealsC3wi' ;
tmpVarNames{end+1} = 'CerealsC3si' ;
cropfracs_out.varNames = tmpVarNames ;
tmpWW_YXy = squeeze(cropfracs_out.maps_YXvy(:,:,strcmp(cropfracs_out.varNames,'CerealsC3wi'),:)) ;
tmpSW_YXy = nan(size(tmpWW_YXy)) ;
tmpSW_YXy(~TeWW_better_YXy) = tmpWW_YXy(~TeWW_better_YXy) ;
tmpSW_YXy(TeWW_better_YXy) = 0 ;
tmpWW_YXy(~TeWW_better_YXy) = 0 ;
cropfracs_out.maps_YXvy(:,:,strcmp(cropfracs_out.varNames,'CerealsC3wi'),:) = reshape(tmpWW_YXy,[size(tmpWW_YXy,1) size(tmpWW_YXy,2) 1 size(tmpWW_YXy,3)]) ;
cropfracs_out.maps_YXvy(:,:,strcmp(cropfracs_out.varNames,'CerealsC3si'),:) = reshape(tmpSW_YXy,[size(tmpSW_YXy,1) size(tmpSW_YXy,2) 1 size(tmpSW_YXy,3)]) ;
clear tmp*

cropfracs_out.maps_YXvy(~repmat(isOK_YX,[1 1 size(cropfracs_out,3) Nyears_out])) = NaN ;

if ~isempty(inFile_nfert)
    if ~isempty(strfind(outFile_nfert,'assignWWorSW'))
        % Do it: nfert, rainfed
        tmpVarNames = nfert_out.varNames ;
        tmpVarNames{strcmp(nfert_out.varNames,'CerealsC3')} = 'CerealsC3w' ;
        tmpVarNames{end+1} = 'CerealsC3s' ;
        nfert_out.varNames = tmpVarNames ;
        if nfert_1yr
            error('nfert_1yr is incompatible with assignWWorSW.')
            tmpWW_YX = squeeze(nfert_out.maps_YXv(:,:,strcmp(nfert_out.varNames,'CerealsC3w'))) ;
            tmpSW_YX = nan(size(tmpWW_YX)) ;
            tmpSW_YX(~TeWW_better_YX) = tmpWW_YX(~TeWW_better_YX) ;
            tmpSW_YX(TeWW_better_YX) = 0 ;
            tmpWW_YX(~TeWW_better_YX) = 0 ;
            nfert_out.maps_YXv(:,:,strcmp(nfert_out.varNames,'CerealsC3w')) = tmpWW_YX ;
            nfert_out.maps_YXv(:,:,strcmp(nfert_out.varNames,'CerealsC3s')) = tmpSW_YX ;
        else
            tmpWW_YXy = squeeze(nfert_out.maps_YXvy(:,:,strcmp(nfert_out.varNames,'CerealsC3w'),:)) ;
            tmpSW_YXy = nan(size(tmpWW_YXy)) ;
            tmpSW_YXy(~TeWW_better_YXy) = tmpWW_YXy(~TeWW_better_YXy) ;
            tmpSW_YXy(TeWW_better_YXy) = 0 ;
            tmpWW_YXy(~TeWW_better_YXy) = 0 ;
            nfert_out.maps_YXvy(:,:,strcmp(nfert_out.varNames,'CerealsC3w'),:) = reshape(tmpWW_YXy,[size(tmpWW_YXy,1) size(tmpWW_YXy,2) 1 size(tmpWW_YXy,3)]) ;
            nfert_out.maps_YXvy(:,:,strcmp(nfert_out.varNames,'CerealsC3s'),:) = reshape(tmpSW_YXy,[size(tmpSW_YXy,1) size(tmpSW_YXy,2) 1 size(tmpSW_YXy,3)]) ;
        end
        clear tmp*
        
        % Do it: nfert, irrigated
        tmpVarNames = nfert_out.varNames ;
        tmpVarNames{strcmp(nfert_out.varNames,'CerealsC3i')} = 'CerealsC3wi' ;
        tmpVarNames{end+1} = 'CerealsC3si' ;
        nfert_out.varNames = tmpVarNames ;
        if nfert_1yr
            tmpWW_YX = squeeze(nfert_out.maps_YXv(:,:,strcmp(nfert_out.varNames,'CerealsC3wi'))) ;
            tmpSW_YX = nan(size(tmpWW_YX)) ;
            tmpSW_YX(~TeWW_better_YX) = tmpWW_YX(~TeWW_better_YX) ;
            tmpSW_YX(TeWW_better_YX) = 0 ;
            tmpWW_YX(~TeWW_better_YX) = 0 ;
            nfert_out.maps_YXv(:,:,strcmp(nfert_out.varNames,'CerealsC3wi')) = tmpWW_YX ;
            nfert_out.maps_YXv(:,:,strcmp(nfert_out.varNames,'CerealsC3si')) = tmpSW_YX ;
        else
            tmpWW_YXy = squeeze(nfert_out.maps_YXvy(:,:,strcmp(nfert_out.varNames,'CerealsC3wi'),:)) ;
            tmpSW_YXy = nan(size(tmpWW_YXy)) ;
            tmpSW_YXy(~TeWW_better_YXy) = tmpWW_YXy(~TeWW_better_YXy) ;
            tmpSW_YXy(TeWW_better_YXy) = 0 ;
            tmpWW_YXy(~TeWW_better_YXy) = 0 ;
            nfert_out.maps_YXvy(:,:,strcmp(nfert_out.varNames,'CerealsC3wi'),:) = reshape(tmpWW_YXy,[size(tmpWW_YXy,1) size(tmpWW_YXy,2) 1 size(tmpWW_YXy,3)]) ;
            nfert_out.maps_YXvy(:,:,strcmp(nfert_out.varNames,'CerealsC3si'),:) = reshape(tmpSW_YXy,[size(tmpSW_YXy,1) size(tmpSW_YXy,2) 1 size(tmpSW_YXy,3)]) ;
        end
        clear tmp*
        
        nfert_out.maps_YXvy(~repmat(isOK_YX,[1 1 size(nfert_out,3) Nyears_out])) = NaN ;
    elseif ~isempty(strfind(outFile_nfert,'WWandSW'))
        % Do it: nfert
        tmpVarNames = nfert_out.varNames ;
        tmpVarNames{strcmp(nfert_out.varNames,'CerealsC3')} = 'CerealsC3w' ;
        tmpVarNames{end+1} = 'CerealsC3s' ;
        tmpVarNames{strcmp(nfert_out.varNames,'CerealsC3i')} = 'CerealsC3wi' ;
        tmpVarNames{end+1} = 'CerealsC3si' ;
        nfert_out.varNames = tmpVarNames ;
        isCerealsC3 = not(cellfun(@isempty,strfind(nfert_out.varNames,'CerealsC3'))) ;
        if length(find(isCerealsC3))~=4
            error('length(find(isCerealsC3))~=4')
        end
        if nfert_1yr
            nfert_out.maps_YXv(:,:,isCerealsC3) = repmat(nfert_out.maps_YXv(:,:,strcmp(nfert_out.varNames,'CerealsC3w')),[1 1 4]) ;
        else
            nfert_out.maps_YXvy(:,:,isCerealsC3,:) = repmat(nfert_out.maps_YXvy(:,:,strcmp(nfert_out.varNames,'CerealsC3w'),:),[1 1 4 1]) ;
        end
    else
        error('What do I do here?')
    end
end

%% Save cropfracs

disp('Preparing to save cropfracs...')

% Get header and formatSpec
out_header_cropfracs = 'Lon Lat Year' ;
for c = 1:length(cropfracs_out.varNames)
    out_header_cropfracs = [out_header_cropfracs ' ' cropfracs_out.varNames{c}] ;
end
out_formatSpec_cropfracs = ['%4.2f %4.2f %4.0f' repmat([' %5.' num2str(outPrec_LC) 'f'],[1 length(cropfracs_out.varNames)])] ;
out_formatSpec_cropfracs = [out_formatSpec_cropfracs '\n'] ;

% Set up output files
Ncells_out = length(yield.list_to_map) ;
outFile_cropfracs = strrep(outFile_cropfracs,'XXXX-XXXX',[num2str(yearList_out(1)) '-' num2str(yearList_out(end))]) ;
outFile_cropfracs = strrep(outFile_cropfracs,'YYYYY',num2str(Ncells_out)) ;
if exist(outFile_cropfracs,'file') && ~force_overwrite
    error(['Outfile already exists! (' outFile_cropfracs ')']) ;
end
fid1_cropfracs = fopen(outFile_cropfracs, 'w') ;
fprintf(fid1_cropfracs,'%s \n',out_header_cropfracs);

cropfracs_maps_yvYX = permute(cropfracs_out.maps_YXvy,[4 3 1 2]) ;

disp('Saving...')
for c = 1:Ncells_out
    
    i = yield.list_to_map(c) ;
    [I,J] = ind2sub([size(cropfracs_out.maps_YXvy,1) size(cropfracs_out.maps_YXvy,2)],i) ;
    thisMat = cropfracs_maps_yvYX(:,:,I,J) ;
    thisLon = lons_map(i) ;
    thisLat = lats_map(i) ;
    
    thisOut = [thisLon*ones(Nyears_out,1) ...
        thisLat*ones(Nyears_out,1) ...
        yearList_out ...
        thisMat] ;
    
    if c>1 && rem(c-1,fclose_every)==0
        fid1_cropfracs = fopen(outFile_cropfracs, 'a+') ;
    end
    
    fprintf(fid1_cropfracs,out_formatSpec_cropfracs,thisOut') ;
    
    if rem(c,fclose_every)==0 || c==Ncells_out
        fclose(fid1_cropfracs) ;
    end
    
    if rem(c,pct_progress*floor(Ncells_out/100))==0
        compltn = 100*(c)/Ncells_out ;
        if compltn>0
            disp(['   ' num2str(round(compltn)) '% complete...'])
        end
    end
end
disp('Done.')


%% Save nfert

%%% Options %%%%%%%%%%%%%
outWidth = 1 ;
delimiter = ' ' ;
fancy = false ;
%%%%%%%%%%%%%%%%%%%%%%%%%

if isempty(inFile_nfert)
    error('inFile_nfert not specified! Not saving nfert output file.')
end

% Set up output files
Ncells_out = length(yield.list_to_map) ;
outFile_nfert = strrep(outFile_nfert,'XXXX-XXXX',[num2str(yearList_out(1)) '-' num2str(yearList_out(end))]) ;
outFile_nfert = strrep(outFile_nfert,'YYYYY',num2str(Ncells_out)) ;
if exist(outFile_nfert,'file') && ~force_overwrite
    error(['Outfile already exists! (' outFile_nfert ')']) ;
end

if nfert_1yr
    [nfert_out_array, nfert_out_header_cell] = lpjgu_matlab_maps2table(nfert_out,nfert_out.list_to_map) ;
    disp('Saving nfert...')
    lpjgu_matlab_saveTable(nfert_out_header_cell, nfert_out_array, outFile_nfert,...
        'outPrec', outPrec_mgmtInputs, ...
        'outWidth', outWidth, ...
        'delimiter', delimiter, ...
        'overwrite', force_overwrite, ...
        'fancy', fancy, ...
        'progress_step_pct', 20) ;
else
    disp('Preparing to save nfert...')
    
    % Get header and formatSpec
    out_header_nfert = 'Lon Lat Year' ;
    for c = 1:length(nfert_out.varNames)
        out_header_nfert = [out_header_nfert ' ' nfert_out.varNames{c}] ;
    end
    out_formatSpec_nfert = ['%4.2f %4.2f %4.0f' repmat([' %5.' num2str(outPrec_mgmtInputs) 'f'],[1 length(nfert_out.varNames)])] ;
    out_formatSpec_nfert = [out_formatSpec_nfert '\n'] ;
    
    % Set up output files
    fid1_nfert = fopen(outFile_nfert, 'w') ;
    fprintf(fid1_nfert,'%s \n',out_header_nfert);
    
    nfert_maps_yvYX = permute(nfert_out.maps_YXvy,[4 3 1 2]) ;
    
    disp('Saving...')
    for c = 1:Ncells_out
        
        i = yield.list_to_map(c) ;
        [I,J] = ind2sub([size(nfert_out.maps_YXvy,1) size(nfert_out.maps_YXvy,2)],i) ;
        thisMat = nfert_maps_yvYX(:,:,I,J) ;
        thisLon = lons_map(i) ;
        thisLat = lats_map(i) ;
        
        thisOut = [thisLon*ones(Nyears_out,1) ...
            thisLat*ones(Nyears_out,1) ...
            yearList_out ...
            thisMat] ;
        
        if c>1 && rem(c-1,fclose_every)==0
            fid1_nfert = fopen(outFile_nfert, 'a+') ;
        end
        
        fprintf(fid1_nfert,out_formatSpec_nfert,thisOut') ;
        
        if rem(c,fclose_every)==0 || c==Ncells_out
            fclose(fid1_nfert) ;
        end
        
        if rem(c,pct_progress*floor(Ncells_out/100))==0
            compltn = 100*(c)/Ncells_out ;
            if compltn>0
                disp(['   ' num2str(round(compltn)) '% complete...'])
            end
        end
        
    end
end
disp('Done.')
